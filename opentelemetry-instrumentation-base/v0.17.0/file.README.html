<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>
  File: README
  
    &mdash; OpenTelemetry
  
</title>

  <link rel="stylesheet" href="css/style.css" type="text/css" />

  <link rel="stylesheet" href="css/common.css" type="text/css" />

<script type="text/javascript">
  pathId = "README";
  relpath = '';
</script>


  <script type="text/javascript" charset="utf-8" src="js/jquery.js"></script>

  <script type="text/javascript" charset="utf-8" src="js/app.js"></script>


  </head>
  <body>
    <div class="nav_wrap">
      <iframe id="nav" src="file_list.html?1"></iframe>
      <div id="resizer"></div>
    </div>

    <div id="main" tabindex="-1">
      <div id="header">
        <div id="menu">
  
    <a href="_index.html">Index</a> &raquo; 
    <span class="title">File: README</span>
  
</div>

        <div id="search">
  
    <a class="full_list_link" id="class_list_link"
        href="class_list.html">

        <svg width="24" height="24">
          <rect x="0" y="4" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="12" width="24" height="4" rx="1" ry="1"></rect>
          <rect x="0" y="20" width="24" height="4" rx="1" ry="1"></rect>
        </svg>
    </a>
  
</div>
        <div class="clear"></div>
      </div>

      <div id="content"><div id='filecontents'>
<h1 id="label-OpenTelemetry+Instrumentation+Base">OpenTelemetry Instrumentation Base</h1>

<p>The <code>opentelemetry-instrumentation-base</code> gem contains the instrumentation base class, and the instrumentation registry. These modules provide a common interface to support the installation of auto instrumentation libraries. The instrumentation base is responsible for adding itself to the instrumentation registry as well as providing convenience hooks for the installation process. The instrumentation registry contains all the instrumentation to be installed during the SDK configuration process.</p>

<h2 id="label-How+do+I+get+started-3F">How do I get started?</h2>

<p>Install the gem using:</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_gem'>gem</span> <span class='id identifier rubyid_install'>install</span> <span class='id identifier rubyid_opentelemetry'>opentelemetry</span><span class='op'>-</span><span class='id identifier rubyid_instrumentation'>instrumentation</span><span class='op'>-</span><span class='id identifier rubyid_base'>base</span>
</code></pre>

<p>Or, if you use <a href="https://bundler.io">bundler</a>, include <code>opentelemetry-instrumentation-base</code> in your <code>Gemfile</code>.</p>

<h3 id="label-For+SDK+Authors">For SDK Authors</h3>

<p>The following is a simplified demonstration of how the <code>OpenTelemetry::Instrumentation.registry</code> can be used by an SDK to install auto-instrumentation gems as part of its configuration. This should not be used as an example of how to implement an SDK as there are large omissions. For an example of a complete implementation see the <code>opentelemetry-sdk</code> gem.</p>

<pre class="code ruby"><code class="ruby"><span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>bundler/inline</span><span class='tstring_end'>&#39;</span></span>

<span class='id identifier rubyid_gemfile'>gemfile</span><span class='lparen'>(</span><span class='kw'>true</span><span class='rparen'>)</span> <span class='kw'>do</span>
  <span class='id identifier rubyid_source'>source</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>https://rubygems.org</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_gem'>gem</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>opentelemetry-api</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_gem'>gem</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>opentelemetry-instrumentation-base</span><span class='tstring_end'>&#39;</span></span>
  <span class='id identifier rubyid_gem'>gem</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>opentelemetry-instrumentation-net_http</span><span class='tstring_end'>&#39;</span></span>
<span class='kw'>end</span>

<span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>opentelemetry-api</span><span class='tstring_end'>&#39;</span></span>
<span class='id identifier rubyid_require'>require</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>opentelemetry-instrumentation-base</span><span class='tstring_end'>&#39;</span></span>

<span class='comment'># Setup a noop custom tracer for our SDK
</span><span class='kw'>class</span> <span class='const'>MyCustomTracer</span> <span class='op'>&lt;</span> <span class='const'><span class='object_link'><a href="OpenTelemetry.html" title="OpenTelemetry (module)">OpenTelemetry</a></span></span><span class='op'>::</span><span class='const'>Trace</span><span class='op'>::</span><span class='const'>Tracer</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_initialize'>initialize</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_version'>version</span><span class='rparen'>)</span>
    <span class='ivar'>@name</span> <span class='op'>=</span> <span class='id identifier rubyid_name'>name</span>
    <span class='ivar'>@version</span> <span class='op'>=</span> <span class='id identifier rubyid_version'>version</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='comment'># Setup a tracer provider for our SDK
</span><span class='kw'>class</span> <span class='const'>MyCustomTracerProvider</span> <span class='op'>&lt;</span> <span class='const'><span class='object_link'><a href="OpenTelemetry.html" title="OpenTelemetry (module)">OpenTelemetry</a></span></span><span class='op'>::</span><span class='const'>Trace</span><span class='op'>::</span><span class='const'>TracerProvider</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_tracer'>tracer</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='comma'>,</span> <span class='id identifier rubyid_version'>version</span> <span class='op'>=</span> <span class='kw'>nil</span><span class='rparen'>)</span>
    <span class='const'>MyCustomTracer</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span><span class='lparen'>(</span><span class='id identifier rubyid_name'>name</span><span class='comma'>,</span> <span class='id identifier rubyid_version'>version</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='kw'>class</span> <span class='const'>MyCustomSDK</span>
  <span class='kw'>def</span> <span class='kw'>self</span><span class='period'>.</span><span class='id identifier rubyid_configure'>configure</span><span class='lparen'>(</span><span class='id identifier rubyid_config'>config</span> <span class='op'>=</span> <span class='lbrace'>{</span><span class='rbrace'>}</span><span class='rparen'>)</span>
    <span class='comment'># It is important that we upgrade the API tracer provider to
</span>    <span class='comment'># our SDK tracer provider so that when the install hook is
</span>    <span class='comment'># called that our instrumentation libraries receive an
</span>    <span class='comment'># SDK tracer instead of the noop API tracer.
</span>    <span class='const'><span class='object_link'><a href="OpenTelemetry.html" title="OpenTelemetry (module)">OpenTelemetry</a></span></span><span class='period'>.</span><span class='id identifier rubyid_tracer_provider'>tracer_provider</span> <span class='op'>=</span> <span class='const'>MyCustomTracerProvider</span><span class='period'>.</span><span class='id identifier rubyid_new'>new</span>
    <span class='const'><span class='object_link'><a href="OpenTelemetry.html" title="OpenTelemetry (module)">OpenTelemetry</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="OpenTelemetry/Instrumentation.html" title="OpenTelemetry::Instrumentation (module)">Instrumentation</a></span></span><span class='period'>.</span><span class='id identifier rubyid_registry'><span class='object_link'><a href="OpenTelemetry/Instrumentation.html#registry-instance_method" title="OpenTelemetry::Instrumentation#registry (method)">registry</a></span></span><span class='period'>.</span><span class='id identifier rubyid_install_all'><span class='object_link'><a href="OpenTelemetry/Instrumentation/Registry.html#install_all-instance_method" title="OpenTelemetry::Instrumentation::Registry#install_all (method)">install_all</a></span></span><span class='lparen'>(</span><span class='id identifier rubyid_config'>config</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='comment'># The config option being passed to through to the registry install_all method.
</span><span class='comment'># This is not a valid configuration option for this instrumentation library
</span><span class='comment'># so the Opentelemetry logger will receive a warning message.
</span><span class='id identifier rubyid_config'>config</span> <span class='op'>=</span> <span class='lbrace'>{</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>OpenTelemetry::Instrumentation::Net::HTTP</span><span class='tstring_end'>&#39;</span></span> <span class='op'>=&gt;</span> <span class='lbrace'>{</span> <span class='label'>foo:</span> <span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>bar</span><span class='tstring_end'>&#39;</span></span> <span class='rbrace'>}</span> <span class='rbrace'>}</span>
<span class='const'>MyCustomSDK</span><span class='period'>.</span><span class='id identifier rubyid_configure'>configure</span><span class='lparen'>(</span><span class='id identifier rubyid_config'>config</span><span class='rparen'>)</span>

<span class='comment'># The purpose of this line is to demonstrate that the instrumentation
</span><span class='comment'># library has received the SDK tracer and is not using the default
</span><span class='comment'># API noop tracer.
</span><span class='id identifier rubyid_puts'>puts</span> <span class='const'><span class='object_link'><a href="OpenTelemetry.html" title="OpenTelemetry (module)">OpenTelemetry</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="OpenTelemetry/Instrumentation.html" title="OpenTelemetry::Instrumentation (module)">Instrumentation</a></span></span><span class='op'>::</span><span class='const'>Net</span><span class='op'>::</span><span class='const'>HTTP</span><span class='op'>::</span><span class='const'>Instrumentation</span><span class='period'>.</span><span class='id identifier rubyid_instance'>instance</span><span class='period'>.</span><span class='id identifier rubyid_tracer'>tracer</span><span class='period'>.</span><span class='id identifier rubyid_inspect'>inspect</span>

<span class='comment'>#### Output
</span><span class='comment'># Fetching gem metadata from https://rubygems.org/..
</span><span class='comment'># Resolving dependencies...
</span><span class='comment'># Using bundler 1.17.3
</span><span class='comment'># Using opentelemetry-api 0.16.0
</span><span class='comment'># Using opentelemetry-common 0.16.0
</span><span class='comment'># Using opentelemetry-instrumentation-base 0.16.0
</span><span class='comment'># Using opentelemetry-instrumentation-net_http 0.16.0
</span><span class='comment'># W, [2021-04-08T17:28:04.430002 #8425]  WARN -- : Instrumentation OpenTelemetry::Instrumentation::Net::HTTP ignored the following unknown configuration options [:foo]
</span><span class='comment'># I, [2021-04-08T17:28:04.430697 #8425]  INFO -- : Instrumentation: OpenTelemetry::Instrumentation::Net::HTTP was successfully installed
</span><span class='comment'># #&lt;MyCustomTracer:0x00007faee43c6c58 @name=&quot;OpenTelemetry::Instrumentation::Net::HTTP&quot;, @version=&quot;0.16.0&quot;&gt;
</span></code></pre>

<h3 id="label-For+auto-instrumentation+authors">For auto-instrumentation authors</h3>

<p>The following is a simplified demonstration of how the <code>OpenTelemetry::Instrumentation::Base</code> class can be used to hook into the instrumentation registry, and the basic functionality provided.</p>

<pre class="code ruby"><code class="ruby"><span class='comment'># A simple class to instrument
</span><span class='kw'>class</span> <span class='const'>SimpleClass</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_greeting'>greeting</span>
    <span class='id identifier rubyid_puts'>puts</span> <span class='tstring'><span class='tstring_beg'>&quot;</span><span class='tstring_content'>hello</span><span class='tstring_end'>&quot;</span></span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='comment'># Our instrumentation patch
</span><span class='kw'>class</span> <span class='const'>SimplePatch</span>
  <span class='kw'>def</span> <span class='id identifier rubyid_greeting'>greeting</span>
    <span class='id identifier rubyid_tracer'>tracer</span><span class='period'>.</span><span class='id identifier rubyid_in_span'>in_span</span><span class='lparen'>(</span><span class='tstring'><span class='tstring_beg'>&#39;</span><span class='tstring_content'>SimpleClass#greeting</span><span class='tstring_end'>&#39;</span></span><span class='rparen'>)</span> <span class='lbrace'>{</span> <span class='kw'>super</span> <span class='rbrace'>}</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_private'>private</span>

  <span class='comment'># We can gain access to the instrumentation tracer using
</span>  <span class='comment'># the instance method available on the class inheriting
</span>  <span class='comment'># from the instrumentation base.
</span>  <span class='kw'>def</span> <span class='id identifier rubyid_tracer'>tracer</span>
    <span class='const'>CustomAutoInstrumentation</span><span class='period'>.</span><span class='id identifier rubyid_instance'>instance</span><span class='period'>.</span><span class='id identifier rubyid_tracer'>tracer</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>

<span class='comment'># The OpenTelemetry::Instrumentation::Base class will implicitly add
</span><span class='comment'># any class that inherits from it to the registry.
</span><span class='comment'># Note that the name of the instrumentation in the registry will match
</span><span class='comment'># the class name and its namespace.  In this example the registry
</span><span class='comment'># will contain &#39;CustomAutoInstrumentation&#39;, if it was within
</span><span class='comment'># a module named `Legacy`, it would take the form `Legacy::CustomAutoInstrumentation`.
</span><span class='kw'>class</span> <span class='const'>CustomAutoInstrumentation</span> <span class='op'>&lt;</span> <span class='const'><span class='object_link'><a href="OpenTelemetry.html" title="OpenTelemetry (module)">OpenTelemetry</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="OpenTelemetry/Instrumentation.html" title="OpenTelemetry::Instrumentation (module)">Instrumentation</a></span></span><span class='op'>::</span><span class='const'><span class='object_link'><a href="OpenTelemetry/Instrumentation/Base.html" title="OpenTelemetry::Instrumentation::Base (class)">Base</a></span></span>
  <span class='comment'># The install hook is provided to apply patches through prepending
</span>  <span class='comment'># or using library hooks if available.
</span>  <span class='id identifier rubyid_install'>install</span> <span class='kw'>do</span> <span class='op'>|</span><span class='id identifier rubyid__config'>_config</span><span class='op'>|</span>
    <span class='id identifier rubyid_patch'>patch</span>
  <span class='kw'>end</span>

  <span class='comment'># The presence check provides a hook so that we can
</span>  <span class='comment'># test for the presence of the class we intend to patch.
</span>  <span class='comment'># If the presence check returns false, we will not
</span>  <span class='comment'># proceed with the installation hook.
</span>  <span class='id identifier rubyid_present'>present</span> <span class='kw'>do</span>
    <span class='kw'>defined?</span><span class='lparen'>(</span><span class='const'>SimpleClass</span><span class='rparen'>)</span>
  <span class='kw'>end</span>

  <span class='id identifier rubyid_private'>private</span>

  <span class='kw'>def</span> <span class='id identifier rubyid_patch'>patch</span>
    <span class='const'>SimpleClass</span><span class='period'>.</span><span class='id identifier rubyid_prepend'>prepend</span><span class='lparen'>(</span><span class='const'>SimplePatch</span><span class='rparen'>)</span>
  <span class='kw'>end</span>
<span class='kw'>end</span>
</code></pre>

<h2 id="label-How+can+I+get+involved-3F">How can I get involved?</h2>

<p>The <code>opentelemetry-instrumentation-base</code> gem source is <a href="https://github.com/open-telemetry/opentelemetry-ruby">on github</a>, along with related gems including <code>opentelemetry-api</code> and <code>opentelemetry-sdk</code>.</p>

<p>The OpenTelemetry Ruby gems are maintained by the OpenTelemetry-Ruby special interest group (SIG). You can get involved by joining us in <a href="https://github.com/open-telemetry/opentelemetry-ruby/discussions">GitHub Discussions</a> or attending our weekly meeting. See the <a href="https://github.com/open-telemetry/community#community-meetings">meeting calendar</a> for dates and times. For more information on this and other language SIGs, see the OpenTelemetry <a href="https://github.com/open-telemetry/community#ruby-sig">community page</a>.</p>

<h2 id="label-License">License</h2>

<p>The <code>opentelemetry-instrumentation-base</code> gem is distributed under the Apache 2.0 license. See <a href="https://github.com/open-telemetry/opentelemetry-ruby/blob/main/LICENSE">LICENSE</a> for more information.</p>
</div></div>

      <div id="footer">
  Generated on Fri Apr 23 15:08:28 2021 by
  <a href="http://yardoc.org" title="Yay! A Ruby Documentation Tool" target="_parent">yard</a>
  0.9.26 (ruby-2.7.3).
</div>

    </div>
  </body>
</html>